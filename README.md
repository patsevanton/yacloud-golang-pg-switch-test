# yacloud-golang-pg-switch-test

–ü—Ä–æ—Å—Ç–æ–π –∫–æ–¥ –Ω–∞ Go –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ PostgreSQL 
–≤ [Yandex Cloud Managed Database](https://cloud.yandex.ru/services/managed-postgresql) –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–∞—Å—Ç–µ—Ä–∞.

–£—Ç–∏–ª–∏—Ç–∞ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫:
- **FQDN –∫–ª–∞—Å—Ç–µ—Ä–∞** (`c-<cluster_id>.rw.mdb.yandexcloud.net`) ‚Äî –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ **—Ç–µ–∫—É—â–∏–π –º–∞—Å—Ç–µ—Ä**
- –û—Ç–¥–µ–ª—å–Ω—ã–º **–∏–Ω—Å—Ç–∞–Ω—Å–∞–º PostgreSQL** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `rc1a-xxx.mdb.yandexcloud.net` –∏ –¥—Ä.)

–ü—Ä–æ–≥—Ä–∞–º–º–∞ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —Ä–æ–ª–∏, –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–æ, –≤–æ –≤—Ä–µ–º—è –∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–∞—Å—Ç–µ—Ä–∞.

---

## üîß –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ FQDN –∏ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Ö–æ—Å—Ç–∞–º PostgreSQL
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Ä–æ–ª–∏ (`pg_is_in_recovery()`)
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–æ–ª–µ–π –º–µ–∂–¥—É FQDN –∏ –ø—Ä—è–º—ã–º–∏ —Ö–æ—Å—Ç–∞–º–∏
- –ñ—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–±–æ—Ç—ã –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏

---

## üóÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
yacloud-golang-pg-switch-test/
‚îú‚îÄ‚îÄ main.go        // –ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–æ–≥—Ä–∞–º–º—É. –ó–¥–µ—Å—å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ª–æ–≥–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, –ø—Ä–æ–≤–µ—Ä–æ–∫ –∏ –≤—ã–≤–æ–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
‚îú‚îÄ‚îÄ config.go      // –°–æ–¥–µ—Ä–∂–∏—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: —Å–ø–∏—Å–æ–∫ —Ö–æ—Å—Ç–æ–≤, –∫—Ä–µ–¥—ã –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î, –ø–æ—Ä—Ç –∏ –¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.
‚îú‚îÄ‚îÄ dbclient.go    // –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏ —Å PostgreSQL. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ FQDN –∏ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Ö–æ—Å—Ç–∞–º.
‚îú‚îÄ‚îÄ checker.go     // –°–æ–¥–µ—Ä–∂–∏—Ç —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç —Ä–æ–ª—å —É–∑–ª–æ–≤ (master/replica), —Å—Ä–∞–≤–Ω–∏–≤–∞—é—Ç –∏—Ö –∏ –≤—ã–≤–æ–¥—è—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
‚îî‚îÄ‚îÄ README.md
```

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

```bash
git clone https://github.com/your-org/yacloud-golang-pg-switch-test.git
cd yacloud-golang-pg-switch-test
```

### 2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

–°–æ–∑–¥–∞–π—Ç–µ `.env` –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ `config.go`:

```env
PG_USER=your_username
PG_PASSWORD=your_password
PG_DB=your_database
CLUSTER_FQDN=c-<cluster_id>.rw.mdb.yandexcloud.net
HOSTS=rc1a-xxx.mdb.yandexcloud.net,rc1a-yyy.mdb.yandexcloud.net,rc1a-zzz.mdb.yandexcloud.net
```

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —É—Ç–∏–ª–∏—Ç—É

```bash
make build
make run
```

---

## üß™ –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∞

1. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ `CLUSTER_FQDN` –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–∞—Å—Ç–µ—Ä–∞.
2. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –∫–∞–∂–¥–æ–º—É –∏–∑ `HOSTS` –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏—Ö —Ä–æ–ª–∏.
3. –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã ‚Äî –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–æ –ø—Ä–∏ —Ç–µ—Å—Ç–∞—Ö failover'–∞.
4. –í—ã–≤–æ–¥–∏—Ç –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª—å (–º–æ–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–¥ Prometheus/—Ñ–∞–π–ª—ã –∏ —Ç.–ø.)

---

## üìã –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞

```
[FQDN –ö–õ–ê–°–¢–ï–†–ê] –ü–æ–¥–∫–ª—é—á–µ–Ω–æ: c-abcde.rw.mdb.yandexcloud.net | –†–æ–ª—å: master
[–•–û–°–¢] rc1a-xxx.mdb.yandexcloud.net | –†–æ–ª—å: replica
[–•–û–°–¢] rc1a-yyy.mdb.yandexcloud.net | –†–æ–ª—å: master
[–•–û–°–¢] rc1a-zzz.mdb.yandexcloud.net | –†–æ–ª—å: replica
‚úÖ –ú–∞—Å—Ç–µ—Ä —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–º—É
```

---

## üìå –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Go 1.18+
- –î—Ä–∞–π–≤–µ—Ä PostgreSQL: `github.com/jackc/pgx`

---

## ü§ù –ö–æ–Ω—Ç—Ä–∏–±—å—é—Ç–∏–Ω–≥

–ü—É–ª–ª-—Ä–µ–∫–≤–µ—Å—Ç—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è! –û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ issue –∏–ª–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–π—Ç–µ —É–ª—É—á—à–µ–Ω–∏—è.
